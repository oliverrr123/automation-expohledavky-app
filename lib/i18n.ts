"use client";

import csHero from '@/locales/cs/hero.json';
import csAboutUs from '@/locales/cs/about-us.json';
import csProcess from '@/locales/cs/process.json';
import csServices from '@/locales/cs/services.json';
import csTestimonials from '@/locales/cs/testimonials.json';
import csPartners from '@/locales/cs/partners.json';
import csAboutPage from '@/locales/cs/about-page.json';
import csServicesPage from '@/locales/cs/services-page.json';
import csDebtCollectionPage from '@/locales/cs/debt-collection-page.json';
import csCorporateReceivablesPage from '@/locales/cs/corporate-receivables-page.json';
import csReceivablesPurchasePage from '@/locales/cs/receivables-purchase-page.json';
import csCompanyPurchasePage from '@/locales/cs/company-purchase-page.json';
import csPromissoryNotesPage from '@/locales/cs/promissory-notes-page.json';
import csPricingPage from '@/locales/cs/pricing-page.json';
import csDictionaryTemplatesPage from '@/locales/cs/dictionary-templates-page.json';
import csCareerPage from '@/locales/cs/career-page.json';
import csContactPage from '@/locales/cs/contact-page.json';
import csBlogPage from '@/locales/cs/blog-page.json';
import csPrivacyPolicyPage from '@/locales/cs/privacy-policy-page.json';
import csHeader from '@/locales/cs/header.json';
import csFooter from '@/locales/cs/footer.json';
import csMetadata from '@/locales/cs/metadata.json';
import csServicesLayout from '@/locales/cs/services-layout.json';
import csLoading from '@/locales/cs/loading.json';
import csInquiryPage from '@/locales/cs/inquiry-page.json';

// English translations
import enHero from '@/locales/en/hero.json';
import enAboutUs from '@/locales/en/about-us.json';
import enProcess from '@/locales/en/process.json';
import enServices from '@/locales/en/services.json';
import enTestimonials from '@/locales/en/testimonials.json';
import enPartners from '@/locales/en/partners.json';
import enAboutPage from '@/locales/en/about-page.json';
import enServicesPage from '@/locales/en/services-page.json';
import enDebtCollectionPage from '@/locales/en/debt-collection-page.json';
import enCorporateReceivablesPage from '@/locales/en/corporate-receivables-page.json';
import enReceivablesPurchasePage from '@/locales/en/receivables-purchase-page.json';
import enCompanyPurchasePage from '@/locales/en/company-purchase-page.json';
import enPromissoryNotesPage from '@/locales/en/promissory-notes-page.json';
import enPricingPage from '@/locales/en/pricing-page.json';
import enDictionaryTemplatesPage from '@/locales/en/dictionary-templates-page.json';
import enCareerPage from '@/locales/en/career-page.json';
import enContactPage from '@/locales/en/contact-page.json';
import enBlogPage from '@/locales/en/blog-page.json';
import enPrivacyPolicyPage from '@/locales/en/privacy-policy-page.json';
import enHeader from '@/locales/en/header.json';
import enFooter from '@/locales/en/footer.json';
import enMetadata from '@/locales/en/metadata.json';
import enServicesLayout from '@/locales/en/services-layout.json';
import enLoading from '@/locales/en/loading.json';
import enInquiryPage from '@/locales/en/inquiry-page.json';

// German translations
import deHero from '@/locales/de/hero.json';
import deAboutUs from '@/locales/de/about-us.json';
import deProcess from '@/locales/de/process.json';
import deServices from '@/locales/de/services.json';
import deTestimonials from '@/locales/de/testimonials.json';
import dePartners from '@/locales/de/partners.json';
import deAboutPage from '@/locales/de/about-page.json';
import deServicesPage from '@/locales/de/services-page.json';
import deDebtCollectionPage from '@/locales/de/debt-collection-page.json';
import deCorporateReceivablesPage from '@/locales/de/corporate-receivables-page.json';
import deReceivablesPurchasePage from '@/locales/de/receivables-purchase-page.json';
import deCompanyPurchasePage from '@/locales/de/company-purchase-page.json';
import dePromissoryNotesPage from '@/locales/de/promissory-notes-page.json';
import dePricingPage from '@/locales/de/pricing-page.json';
import deDictionaryTemplatesPage from '@/locales/de/dictionary-templates-page.json';
import deCareerPage from '@/locales/de/career-page.json';
import deContactPage from '@/locales/de/contact-page.json';
import deBlogPage from '@/locales/de/blog-page.json';
import dePrivacyPolicyPage from '@/locales/de/privacy-policy-page.json';
import deHeader from '@/locales/de/header.json';
import deFooter from '@/locales/de/footer.json';
import deMetadata from '@/locales/de/metadata.json';
import deServicesLayout from '@/locales/de/services-layout.json';
import deLoading from '@/locales/de/loading.json';
import deInquiryPage from '@/locales/de/inquiry-page.json';

// Slovak translations
import skHero from '@/locales/sk/hero.json';
import skAboutUs from '@/locales/sk/about-us.json';
import skProcess from '@/locales/sk/process.json';
import skServices from '@/locales/sk/services.json';
import skTestimonials from '@/locales/sk/testimonials.json';
import skPartners from '@/locales/sk/partners.json';
import skAboutPage from '@/locales/sk/about-page.json';
import skServicesPage from '@/locales/sk/services-page.json';
import skDebtCollectionPage from '@/locales/sk/debt-collection-page.json';
import skCorporateReceivablesPage from '@/locales/sk/corporate-receivables-page.json';
import skReceivablesPurchasePage from '@/locales/sk/receivables-purchase-page.json';
import skCompanyPurchasePage from '@/locales/sk/company-purchase-page.json';
import skPromissoryNotesPage from '@/locales/sk/promissory-notes-page.json';
import skPricingPage from '@/locales/sk/pricing-page.json';
import skDictionaryTemplatesPage from '@/locales/sk/dictionary-templates-page.json';
import skCareerPage from '@/locales/sk/career-page.json';
import skContactPage from '@/locales/sk/contact-page.json';
import skBlogPage from '@/locales/sk/blog-page.json';
import skPrivacyPolicyPage from '@/locales/sk/privacy-policy-page.json';
import skHeader from '@/locales/sk/header.json';
import skFooter from '@/locales/sk/footer.json';
import skMetadata from '@/locales/sk/metadata.json';
import skServicesLayout from '@/locales/sk/services-layout.json';
import skLoading from '@/locales/sk/loading.json';
import skInquiryPage from '@/locales/sk/inquiry-page.json';

import { getLanguageFromHostname } from './domain-mapping';
import Cookies from 'js-cookie';
import { getInitialLocale } from './server-utils-client';
import { useState, useEffect, useMemo } from 'react';
import * as React from 'react';

// Add the custom __LOCALE__ property to Window
declare global {
  interface Window {
    __LOCALE__?: string;
    __TRANSLATIONS__?: Record<string, Record<string, any>>;
  }
}

// Cookie name for storing the locale (keep in sync with middleware.ts)
const LOCALE_COOKIE = 'NEXT_LOCALE';

// Available locales
export const locales = ['cs', 'sk', 'de', 'en'];

// All translations by locale and namespace
const translations: Record<string, Record<string, any>> = {
  cs: {
    hero: csHero,
    aboutUs: csAboutUs,
    process: csProcess,
    services: csServices,
    testimonials: csTestimonials,
    partners: csPartners,
    aboutPage: csAboutPage,
    servicesPage: csServicesPage,
    debtCollectionPage: csDebtCollectionPage,
    corporateReceivablesPage: csCorporateReceivablesPage,
    receivablesPurchasePage: csReceivablesPurchasePage,
    companyPurchasePage: csCompanyPurchasePage,
    promissoryNotesPage: csPromissoryNotesPage,
    pricingPage: csPricingPage,
    dictionaryTemplatesPage: csDictionaryTemplatesPage,
    careerPage: csCareerPage,
    contactPage: csContactPage,
    blogPage: csBlogPage,
    privacyPolicyPage: csPrivacyPolicyPage,
    header: csHeader,
    footer: csFooter,
    metadata: csMetadata,
    servicesLayout: csServicesLayout,
    loading: csLoading,
    inquiryPage: csInquiryPage
  },
  en: {
    hero: enHero,
    aboutUs: enAboutUs,
    process: enProcess,
    services: enServices,
    testimonials: enTestimonials,
    partners: enPartners,
    aboutPage: enAboutPage,
    servicesPage: enServicesPage,
    debtCollectionPage: enDebtCollectionPage,
    corporateReceivablesPage: enCorporateReceivablesPage,
    receivablesPurchasePage: enReceivablesPurchasePage,
    companyPurchasePage: enCompanyPurchasePage,
    promissoryNotesPage: enPromissoryNotesPage,
    pricingPage: enPricingPage,
    dictionaryTemplatesPage: enDictionaryTemplatesPage,
    careerPage: enCareerPage,
    contactPage: enContactPage,
    blogPage: enBlogPage,
    privacyPolicyPage: enPrivacyPolicyPage,
    header: enHeader,
    footer: enFooter,
    metadata: enMetadata,
    servicesLayout: enServicesLayout,
    loading: enLoading,
    inquiryPage: enInquiryPage
  },
  de: {
    hero: deHero,
    aboutUs: deAboutUs,
    process: deProcess,
    services: deServices,
    testimonials: deTestimonials,
    partners: dePartners,
    aboutPage: deAboutPage,
    servicesPage: deServicesPage,
    debtCollectionPage: deDebtCollectionPage,
    corporateReceivablesPage: deCorporateReceivablesPage,
    receivablesPurchasePage: deReceivablesPurchasePage,
    companyPurchasePage: deCompanyPurchasePage,
    promissoryNotesPage: dePromissoryNotesPage,
    pricingPage: dePricingPage,
    dictionaryTemplatesPage: deDictionaryTemplatesPage,
    careerPage: deCareerPage,
    contactPage: deContactPage,
    blogPage: deBlogPage,
    privacyPolicyPage: dePrivacyPolicyPage,
    header: deHeader,
    footer: deFooter,
    metadata: deMetadata,
    servicesLayout: deServicesLayout,
    loading: deLoading,
    inquiryPage: deInquiryPage
  },
  sk: {
    hero: skHero,
    aboutUs: skAboutUs,
    process: skProcess,
    services: skServices,
    testimonials: skTestimonials,
    partners: skPartners,
    aboutPage: skAboutPage,
    servicesPage: skServicesPage,
    debtCollectionPage: skDebtCollectionPage,
    corporateReceivablesPage: skCorporateReceivablesPage,
    receivablesPurchasePage: skReceivablesPurchasePage,
    companyPurchasePage: skCompanyPurchasePage,
    promissoryNotesPage: skPromissoryNotesPage,
    pricingPage: skPricingPage,
    dictionaryTemplatesPage: skDictionaryTemplatesPage,
    careerPage: skCareerPage,
    contactPage: skContactPage,
    blogPage: skBlogPage,
    privacyPolicyPage: skPrivacyPolicyPage,
    header: skHeader,
    footer: skFooter,
    metadata: skMetadata,
    servicesLayout: skServicesLayout,
    loading: skLoading,
    inquiryPage: skInquiryPage
  }
};

// Define a global cache for empty translation structures
const emptyStructuresCache: Record<string, any> = {};

/**
 * Get an empty translation structure with memoization
 */
function getEmptyStructure(namespace: string): any {
  if (!emptyStructuresCache[namespace]) {
    emptyStructuresCache[namespace] = createEmptyTranslationStructure(namespace);
  }
  return emptyStructuresCache[namespace];
}

/**
 * Get current locale from cookies, browser settings, or window global 
 */
export function getCurrentLocale(): string {
  // Server-side rendering (SSR) or static site generation (SSG)
  if (typeof window === 'undefined') {
    // Get locale from server-side function, no fallbacks
    return getInitialLocale();
  }

  // First priority: global variable set by _document.tsx or early script execution
  if (window.__LOCALE__ && ['cs', 'sk', 'de', 'en'].includes(window.__LOCALE__)) {
    return window.__LOCALE__;
  }
  
  // Second priority: check localStorage for saved locale
  try {
    const storedLocale = localStorage.getItem('__LOCALE__');
    if (storedLocale && ['cs', 'sk', 'de', 'en'].includes(storedLocale)) {
      return storedLocale;
    }
  } catch (e) {
    console.error('Error accessing localStorage:', e);
  }

  // Third priority: check cookie
  const cookieLocale = Cookies.get(LOCALE_COOKIE);
  if (cookieLocale && ['cs', 'sk', 'de', 'en'].includes(cookieLocale)) {
    return cookieLocale;
  }

  // Use hostname detection, no default fallback
  return getInitialLocale();
}

/**
 * Set and store user locale preference
 */
export function setLocale(locale: string) {
  if (typeof window === 'undefined') {
    return;
  }
  
  // Set cookie for future visits (30 days expiry)
  Cookies.set(LOCALE_COOKIE, locale, { expires: 30 });
  
  // Set global variable to ensure consistency during the session
  window.__LOCALE__ = locale;
  
  // Reload page to apply the new locale
  window.location.reload();
}

/**
 * Get translations for a namespace in a specific locale
 */
export function getTranslations(namespace: string, locale?: string) {
  // For server-side rendering, default to cs (but never return undefined)
  const defaultLocale = 'cs';
  const currentLocale = locale || (typeof window !== 'undefined' ? getCurrentLocale() : defaultLocale);
  
  try {
    // Get translations namespace key
    const fixedNamespace = namespace.replace(/-/g, ''); // Convert dashed names to camelCase
    const nsKey = fixedNamespace as keyof typeof translations.cs;
    
    // Get the locale dictionary without fallback
    const localeDict = translations[currentLocale as keyof typeof translations];
    if (!localeDict) {
      // Instead of returning empty object, return empty objects for each possible key
      // to avoid "cannot read property of undefined" errors
      return createEmptyTranslationStructure(namespace);
    }
    
    // Get the translation or empty object with structure preservation
    const translation = localeDict[nsKey];
    if (!translation) {
      return createEmptyTranslationStructure(namespace);
    }
    
    return translation;
  } catch (error) {
    console.error(`Translation error for namespace ${namespace} in locale ${currentLocale}:`, error);
    // Return structured empty object instead of undefined
    return createEmptyTranslationStructure(namespace);
  }
}

/**
 * Create an empty translation structure based on namespace to avoid undefined errors
 */
function createEmptyTranslationStructure(namespace: string): any {
  // Normalize namespace to match our internal naming
  const normalizedNamespace = namespace.replace(/-/g, '');
  
  // Standard structures for common namespaces
  switch(normalizedNamespace) {
    case 'header':
      return { 
        navigation: [{
          label: '',
          href: '',
          items: []
        }], 
        buttons: {
          contact: '',
          language: ''
        },
        mobileMenu: {
          close: ''
        }
      };
    case 'footer':
      return { 
        sections: [{
          title: '',
          links: [{
            label: '',
            href: ''
          }]
        }],
        copyrightText: '',
        buttons: {
          backToTop: ''
        }
      };
    case 'hero':
      return {
        headline1: '',
        headline2: '',
        description: '',
        quote: '',
        buttons: {
          collect: '',
          sell: ''
        }
      };
    case 'blogpage':
      return {
        pageTitle: '',
        search: {
          placeholder: '',
          button: '',
          noResults: '',
          resultsCount: ''
        },
        featured: '',
        readMore: '',
        allArticles: '',
        categories: '',
        recentPosts: '',
        relatedPosts: ''
      };
    case 'pricing':
    case 'pricingpage':
    case 'cenik':
      return {
        header: {
          title: '',
          subtitle: ''
        },
        plans: [],
        comparison: {
          title: '',
          subtitle: '',
          features: []
        },
        faq: {
          title: '',
          items: []
        },
        cta: {
          title: '',
          description: '',
          button: ''
        }
      };
    case 'debtcollectionpage':
    case 'corporatereceivablespage':
    case 'receivablespurchasepage':
    case 'companypurchasepage':
    case 'promissorynotespage':
    case 'vymahanipohledavek':
    case 'pohledavkypravnickychosob':
    case 'odkupprodejpohledavek':
    case 'odkupfirmy':
    case 'smenky':
      return {
        badge: '',
        title: '',
        subtitle: '',
        description: '',
        features: [],
        cta: {
          title: '',
          description: '',
          button: ''
        },
        steps: [],
        benefits: {
          title: '',
          items: []
        },
        faq: {
          title: '',
          items: []
        }
      };
    case 'serviceslayout':
      return {
        pageTitle: '',
        services: []
      };
    case 'process':
      return {
        title: '',
        subtitle: '',
        steps: [
          { key: "kontrola", title: "", description: "" },
          { key: "zastoupeni", title: "", description: "" },
          { key: "vyzva", title: "", description: "" },
          { key: "zaloba", title: "", description: "" },
          { key: "exekuce", title: "", description: "" }
        ]
      };
    case 'testimonials':
      return {
        title: '',
        subtitle: '',
        ariaLabels: {
          previousTestimonial: '',
          nextTestimonial: '',
          goToSlide: ''
        },
        testimonials: [
          {
            text: '',
            author: '',
            company: ''
          }
        ]
      };
    case 'partners':
      return {
        rankingText: '',
        entuzioUrl: '',
        entuzioLinkText: '',
        partners: [
          {
            name: '',
            logo: ''
          }
        ]
      };
    case 'services':
      return {
        badge: '',
        title: '',
        subtitle: '',
        linkText: '',
        services: [
          {
            title: '',
            description: '',
            href: ''
          }
        ]
      };
    case 'aboutpage':
      return {
        hero: {
          title: '',
          subtitle: ''
        },
        mainContent: {
          paragraphs: []
        },
        features: {
          title: '',
          items: []
        },
        success: {
          title: '',
          paragraphs: [],
          arbitration: {
            title: '',
            advantages: []
          }
        },
        comparison: {
          title: '',
          professional: {
            title: '',
            advantages: []
          },
          diy: {
            title: '',
            disadvantages: []
          }
        }
      };
    default:
      // Generic empty structure
      return {};
  }
}

/**
 * Hook for accessing translations within components
 */
export function useTranslations(namespace: string, locale?: string): any {
  // Check if we're in the browser environment
  const isBrowser = typeof window !== 'undefined';
  
  // Initialize with an empty object
  const [translationState, setTranslationState] = useState({});
  
  useEffect(() => {
    // Only run on client
    if (!isBrowser) return;
    
    // Get translations directly
    const currentLocale = locale || getCurrentLocale();
    const fixedNamespace = namespace.replace(/-/g, '');
    
    try {
      // Get the locale dictionary
      const localeDict = translations[currentLocale as keyof typeof translations] || {};
      const nsKey = fixedNamespace as keyof typeof localeDict;
      
      // Safely set the translation object - always return at least an empty object
      setTranslationState(localeDict[nsKey] || {});
    } catch (error) {
      console.error(`Translation error for namespace ${namespace} in locale ${currentLocale}:`, error);
      setTranslationState({});
    }
  }, [namespace, locale, isBrowser]);
  
  return translationState;
}

/**
 * Get metadata for a specific locale
 */
export function getLocaleMetadata(locale?: string) {
  const localeToUse = locale || (typeof window !== 'undefined' ? getCurrentLocale() : 'cs');
  
  // Return only the metadata for the requested locale, no fallbacks
  if (localeToUse && translations[localeToUse]?.metadata) {
    return translations[localeToUse].metadata;
  }
  
  // If metadata isn't available for this locale, return empty object
  return {};
}

/**
 * Alias for getLocaleMetadata for backward compatibility
 * @deprecated Use getLocaleMetadata instead
 */
export const getMetadata = getLocaleMetadata;

/**
 * Server-side safe function to get translations
 * This function doesn't use React hooks and is safe to use in Server Components
 */
export function getServerTranslations(namespace: string, locale?: string): any {
  // Ensure we have a locale
  const currentLocale = locale || 'cs'; // Default to Czech if no locale provided
  
  // Normalize namespace to match our internal naming
  const fixedNamespace = namespace.replace(/-/g, '');
  
  try {
    // Get the locale dictionary
    const localeDict = translations[currentLocale as keyof typeof translations] || {};
    const nsKey = fixedNamespace as keyof typeof localeDict;
    
    // Return the translations or empty object if not found
    return localeDict[nsKey] || {};
  } catch (error) {
    console.error(`Translation error for namespace ${namespace} in locale ${currentLocale}:`, error);
    return {}; // Return empty object on error
  }
} 